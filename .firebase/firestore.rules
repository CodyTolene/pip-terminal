// https://firebase.google.com/docs/firestore/security/rules-fields
// https://firebase.google.com/docs/firestore/security/rules-structure#granular_operations

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    function signedIn() { return request.auth != null; }

    // ***** User profile rules *****
    match /users/{uid} {
      allow read: if isOwner(uid);
      allow create, update: if isOwner(uid) && isValidProfile(request.resource.data);
      allow delete: if isOwner(uid);
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function isValidProfile(d) {
      return validDob(d) && validRoomNumber(d) && validSkill(d) && validVaultNumber(d);
    }

    // dateOfBirth (string):
    //  - missing or null allowed
    //  - if present: YYYY-MM-DD OR full ISO with Z or Â±HH:MM
    //  - must be >= 1900-01-01
    function validDob(d) {
      return !('dateOfBirth' in d) ||
        d.dateOfBirth == null ||
        (
          d.dateOfBirth is string &&
          (
            d.dateOfBirth.matches('^\\d{4}-\\d{2}-\\d{2}$') ||
            d.dateOfBirth.matches('^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{3})?(Z|[+-]\\d{2}:\\d{2})$')
          ) &&
          d.dateOfBirth >= '1900-01-01'
        );
    }

    // roomNumber: optional/null OR int in [1, 999]
    function validRoomNumber(d) {
      return !('roomNumber' in d) ||
        d.roomNumber == null ||
        (d.roomNumber is int && d.roomNumber >= 1 && d.roomNumber <= 999);
    }

    // skill: optional/null OR string length in [2, 128]
    function validSkill(d) {
      return !('skill' in d) ||
        d.skill == null ||
        (
          d.skill is string &&
          d.skill.size() >= 2 &&
          d.skill.size() <= 128
        );
    }

    // vaultNumber: optional/null OR int in [1, 999]
    function validVaultNumber(d) {
      return !('vaultNumber' in d) ||
        d.vaultNumber == null ||
        (d.vaultNumber is int && d.vaultNumber >= 1 && d.vaultNumber <= 999);
    }

    // ***** Forum rules *****
    // A forum post document lives at /forum/{postId}.
    match /forum/{postId} {
      // Allow anyone to read forum posts (including unauthenticated visitors).
      allow read: if true;

      // Create requires authentication and must abide by length/field checks.
      allow create: if signedIn() &&
        request.resource.data.authorId == request.auth.uid &&
        request.resource.data.contentHtml is string &&
        request.resource.data.contentHtml.size() > 0 &&
        request.resource.data.contentHtml.size() <= 4096 &&
        request.resource.data.title is string &&
        request.resource.data.title.size() > 0 &&
        request.resource.data.title.size() <= 256 &&
        request.resource.data.createdAt == request.time;

      // Users may update or delete only their own posts, but cannot touch flagsCount.
      allow update, delete: if signedIn()
        && resource.data.authorId == request.auth.uid
        && request.resource.data.flagsCount == resource.data.flagsCount;

      // Comments subcollection under a post
      match /comments/{commentId} {
        allow read: if true;
        allow create: if signedIn() &&
          request.resource.data.authorId == request.auth.uid &&
          request.resource.data.postId == postId &&
          request.resource.data.content is string &&
          request.resource.data.content.size() > 0 &&
          request.resource.data.content.size() <= 2048 &&
          request.resource.data.createdAt == request.time;
        allow update, delete: if signedIn() && resource.data.authorId == request.auth.uid;
      }

     match /flags/{uid} {
        // one doc per user per post
        allow read: if signedIn();

        // allow create only if it doesn't exist, and only by the owner uid
        allow create: if signedIn()
          && request.auth.uid == uid
          && !exists(/databases/$(database)/documents/forum/$(postId)/flags/$(uid));

        // owner may remove their flag
        allow delete: if signedIn() && request.auth.uid == uid;
      }
    }
  }
}