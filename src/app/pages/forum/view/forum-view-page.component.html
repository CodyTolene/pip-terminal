@if (post(); as post) {
  <pip-forum-header
    [category]="post.category"
    [post]="post"
    [user]="userChanges | async"
  />

  <section class="post">
    <pip-title h2>Forum Post</pip-title>
    <pip-panel>
      <pip-forum-post [post]="post" simple />
    </pip-panel>
  </section>

  <section class="comments">
    <pip-title h3>Comments</pip-title>
    <div class="actions">
      @if (userChanges | async; as user) {
        @if (isReplying()) {
          <form [formGroup]="formGroup" (ngSubmit)="submitComment()">
            <pro-input-textarea
              [formControl]="formGroup.controls.content"
              appearance="outline"
              label="Comment"
              placeholder="Add a comment..."
            ></pro-input-textarea>
            <div class="action-buttons">
              <pip-button [disabled]="isSubmitting()" (click)="cancelComment()">
                Cancel
              </pip-button>
              <pip-button
                type="submit"
                [disabled]="formGroup.invalid || isSubmitting()"
              >
                Submit
              </pip-button>
            </div>
          </form>
        } @else {
          <div class="action-buttons">
            <pip-button (click)="isReplying.set(true); formGroup.reset()"
              >Reply</pip-button
            >
            <ng-container *ngTemplateOutlet="sorting" />
            <ng-container *ngTemplateOutlet="commentPagination" />
          </div>
        }
      } @else {
        <div class="action-buttons">
          <pip-button
            [routerLink]="loginLink"
            [queryParams]="getReturnUrlQueryParams()"
            >Reply</pip-button
          >
          <ng-container *ngTemplateOutlet="sorting" />
          <ng-container *ngTemplateOutlet="commentPagination" />
        </div>
      }
    </div>
    @if (comments().length > 0) {
      @for (comment of comments(); track comment.id) {
        <pip-panel>
          <pip-forum-comment [comment]="comment" />
        </pip-panel>
      }
    } @else {
      <p class="no-comments"><i>No comments yet.</i></p>
    }
  </section>
} @else if (loading()) {
  <p>[LOADING] Please stand by...</p>
} @else if (error()) {
  <p>[ERROR] Unable to load post. Please try again later.</p>
}

<ng-template #commentPagination>
  <div class="pagination">
    <pip-button
      (click)="prevPageComments()"
      [disabled]="loadingComments() || !hasPrevCommentsPage()"
      [matTooltip]="'Previous Page'"
    >
      <mat-icon fontSet="material-icons-outlined">chevron_left</mat-icon>
    </pip-button>
    <pip-button
      (click)="nextPageComments()"
      [disabled]="loadingComments() || !hasNextCommentsPage()"
      [matTooltip]="'Next Page'"
    >
      <mat-icon fontSet="material-icons-outlined">chevron_right</mat-icon>
    </pip-button>
  </div>
</ng-template>

<ng-template #sorting>
  <pro-input-dropdown
    [formControl]="commentSortOrderFormControl"
    hideHint
    label="Sorting"
  >
    <pro-input-dropdown-option [value]="{ key: 'createdAt', direction: 'asc' }"
      >Date Ascending</pro-input-dropdown-option
    >
    <pro-input-dropdown-option [value]="{ key: 'createdAt', direction: 'desc' }"
      >Date Descending</pro-input-dropdown-option
    >
  </pro-input-dropdown>
</ng-template>

<pip-footer />
